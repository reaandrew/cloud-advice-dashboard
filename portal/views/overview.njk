{% extends "template.njk" %}

{% block pageTitle %}{{ serviceName }}{% endblock %}

{% block content %}
<div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
        <h1 class="govuk-heading-xl">{{ serviceName }}</h1>
        
        <p class="govuk-body-l">
            Welcome to the Cloud Advice Dashboard. This application provides insights into your cloud infrastructure compliance and policy management.
        </p>

        {% if dashboardMetrics %}
          <div class="govuk-grid-row">
            <div class="govuk-grid-column-full">
              <h2 class="govuk-heading-l">Compliance Overview</h2>
              {% if dashboardMetrics.date %}
                <p class="govuk-body-s govuk-!-margin-bottom-6">Data as of {{ dashboardMetrics.date }}</p>
              {% endif %}
            </div>
          </div>
          
          <!-- Dashboard metrics grid -->
          {% if dashboardMetrics.metrics %}
            {% set metricsArray = [] %}
            {% for metricId, metric in dashboardMetrics.metrics %}
              {% set metricsArray = (metricsArray.push(metric), metricsArray) %}
            {% endfor %}
            {% set sortedMetrics = metricsArray | sort(false, false, 'order') %}
            
            {% for metric in sortedMetrics %}
              {% if loop.index0 % 4 == 0 %}
                <div class="govuk-grid-row govuk-!-margin-bottom-6" style="display: flex; flex-wrap: wrap;">
              {% endif %}
              
              <div class="govuk-grid-column-one-quarter">
                <div class="govuk-summary-card">
                  <div class="govuk-summary-card__title-wrapper">
                    <h2 class="govuk-summary-card__title">{{ metric.title }}</h2>
                  </div>
                  <div class="govuk-summary-card__content">
                    <div style="text-align: center; padding: 8px 16px;">
                      {% set colorClass = 'var(--app-primary-green)' %}
                      {% if metric.colorScheme == 'success' %}
                        {% set colorClass = 'var(--govuk-colour-green)' %}
                      {% elif metric.colorScheme == 'warning' %}
                        {% set colorClass = 'var(--govuk-colour-orange)' %}
                      {% elif metric.colorScheme == 'error' %}
                        {% set colorClass = 'var(--govuk-colour-red)' %}
                      {% endif %}
                      
                      <div class="govuk-heading-xl govuk-!-margin-bottom-2" style="color: {{ colorClass }};">
                        {{ metric.formattedValue or (metric.value + '%') }}
                      </div>
                      <p class="govuk-body-s govuk-!-margin-bottom-0">{{ metric.description }}</p>
                      {% if metric.error %}
                        <p class="govuk-body-s govuk-!-margin-top-2" style="color: var(--govuk-colour-red);">
                          Error: {{ metric.error }}
                        </p>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
              
              {% if loop.index % 4 == 0 or loop.last %}
                {% for i in range(loop.index % 4, 4) %}
                  {% if not loop.last %}
                    <div class="govuk-grid-column-one-quarter">
                      <!-- Empty column for alignment -->
                    </div>
                  {% endif %}
                {% endfor %}
                </div>
              {% endif %}
            {% endfor %}
          {% endif %}
          
          <!-- Key Metrics Table -->
          {% if dashboardMetrics.metrics %}
          <div class="govuk-grid-row govuk-!-margin-top-6">
            <div class="govuk-grid-column-full">
              <h2 class="govuk-heading-l">Key Metrics</h2>
              
              <table class="govuk-table">
                <thead class="govuk-table__head">
                  <tr class="govuk-table__row">
                    <th scope="col" class="govuk-table__header">Metric</th>
                    <th scope="col" class="govuk-table__header">Value</th>
                  </tr>
                </thead>
                <tbody class="govuk-table__body">
                  {% for metricId, metric in dashboardMetrics.metrics %}
                    {% if metric.keyDetail %}
                    <tr class="govuk-table__row">
                      {% if metricId == 'overall-compliance' %}
                        <th scope="row" class="govuk-table__header">Resources missing mandatory tags</th>
                      {% elif metricId == 'secure-loadbalancers' %}
                        <th scope="row" class="govuk-table__header">Load balancers with deprecated TLS</th>
                      {% elif metricId == 'current-db-versions' %}
                        <th scope="row" class="govuk-table__header">Databases with deprecated versions</th>
                      {% elif metricId == 'kms-rotation' %}
                        <th scope="row" class="govuk-table__header">KMS keys over 2 years old</th>
                      {% elif metricId == 'auto-scaling-efficiency' %}
                        <th scope="row" class="govuk-table__header">Empty auto scaling groups</th>
                      {% elif metricId == 'modern-loadbalancers' %}
                        <th scope="row" class="govuk-table__header">Load balancers using deprecated Classic ELB</th>
                      {% elif metricId == 'active-albs' %}
                        <th scope="row" class="govuk-table__header">Inactive ALBs</th>
                      {% elif metricId == 'configured-albs' %}
                        <th scope="row" class="govuk-table__header">Misconfigured ALBs</th>
                      {% else %}
                        <th scope="row" class="govuk-table__header">{{ metric.title }}</th>
                      {% endif %}
                      <td class="govuk-table__cell">{{ metric.keyDetail }}</td>
                    </tr>
                    {% endif %}
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
          {% endif %}
          
          <hr class="govuk-section-break govuk-section-break--l govuk-section-break--visible">
        {% else %}
          <div class="govuk-warning-text">
            <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
            <strong class="govuk-warning-text__text">
              <span class="govuk-warning-text__assistive">Warning</span>
              Dashboard metrics are currently unavailable. Please check back later.
            </strong>
          </div>
        {% endif %}

        <div class="govuk-grid-row">
            <div class="govuk-grid-column-one-half">
                <div class="govuk-panel govuk-panel--confirmation">
                    <h2 class="govuk-panel__title">
                        <a href="/compliance" class="govuk-link govuk-link--no-visited-state" style="color: inherit; text-decoration: none;">
                            Reports
                        </a>
                    </h2>
                    <div class="govuk-panel__body">
                        View compliance reports and audit findings for your cloud resources.
                    </div>
                </div>
            </div>

            <div class="govuk-grid-column-one-half">
                <div class="govuk-panel govuk-panel--confirmation">
                    <h2 class="govuk-panel__title">
                        <a href="/policies" class="govuk-link govuk-link--no-visited-state" style="color: inherit; text-decoration: none;">
                            Policies
                        </a>
                    </h2>
                    <div class="govuk-panel__body">
                        Access policy documents and governance guidelines.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}