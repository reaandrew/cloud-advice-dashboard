{% extends "policies/policy.njk" %}
{% block policy_content %}
<h1 class="govuk-heading-l" id="top">{{ policy_title }}</h1>
<p class="govuk-body">This page provides a comprehensive view of compliance metrics across all tenants. Each table shows summary statistics for a different compliance area.</p>

{% if tenants %}
    <p class="govuk-body">
        <strong>Jump to section:</strong>
        <a class="govuk-link" href="#tagging">Tagging</a> |
        <a class="govuk-link" href="#database">Database</a> |
        <a class="govuk-link" href="#loadbalancers">Load Balancers</a> |
        <a class="govuk-link" href="#kms">KMS Keys</a> |
        <a class="govuk-link" href="#autoscaling">Auto Scaling</a>
    </p>

    {# Tagging Compliance Table #}
    <h2 class="govuk-heading-m" id="tagging">
        Tagging Compliance
        <a class="govuk-link govuk-body-s" href="#top" style="float: right; font-weight: normal;">Back to top</a>
    </h2>
    <p class="govuk-body-s">
        Shows the compliance status of resources with mandatory tags. Non-compliant resources are missing one or more required tags.
    </p>
    <table class="govuk-table">
        <thead class="govuk-table__head">
            <tr class="govuk-table__row">
                <th class="govuk-table__header" style="width: 25%">Tenant</th>
                <th class="govuk-table__header govuk-table__header--numeric">Total Resources</th>
                <th class="govuk-table__header govuk-table__header--numeric">Compliant</th>
                <th class="govuk-table__header govuk-table__header--numeric">Non-Compliant</th>
                <th class="govuk-table__header govuk-table__header--numeric">Compliance Rate</th>
            </tr>
        </thead>
        <tbody class="govuk-table__body">
            {% for tenant in tenants %}
                {% if tenant.tagging.totalResources > 0 %}
                <tr class="govuk-table__row">
                    <td class="govuk-table__cell">
                        <strong>{{ tenant.tenantName }}</strong>
                        {% if tenant.tenantDescription %}
                            <br><span class="govuk-body-s" style="color: #505a5f;">{{ tenant.tenantDescription }}</span>
                        {% endif %}
                    </td>
                    <td class="govuk-table__cell govuk-table__cell--numeric">{{ tenant.tagging.totalResources }}</td>
                    <td class="govuk-table__cell govuk-table__cell--numeric" style="background-color: #f0f9f0;">
                        {{ tenant.tagging.totalResources - tenant.tagging.nonCompliantResources }}
                    </td>
                    <td class="govuk-table__cell govuk-table__cell--numeric"{% if tenant.tagging.nonCompliantResources > 0 %} style="background-color: #fef2f2;"{% endif %}>
                        {{ tenant.tagging.nonCompliantResources }}
                    </td>
                    <td class="govuk-table__cell govuk-table__cell--numeric">
                        {% if tenant.tagging.complianceRate != 'N/A' %}
                            {{ tenant.tagging.complianceRate }}%
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                </tr>
                {% endif %}
            {% endfor %}
        </tbody>
    </table>

    {# Database Compliance Table #}
    <h2 class="govuk-heading-m" id="database">
        Database Compliance
        <a class="govuk-link govuk-body-s" href="#top" style="float: right; font-weight: normal;">Back to top</a>
    </h2>
    <p class="govuk-body-s">
        Shows the status of database instances. Deprecated databases are running versions that have reached end-of-support.
    </p>
    <table class="govuk-table">
        <thead class="govuk-table__head">
            <tr class="govuk-table__row">
                <th class="govuk-table__header" style="width: 25%">Tenant</th>
                <th class="govuk-table__header govuk-table__header--numeric">Total Databases</th>
                <th class="govuk-table__header govuk-table__header--numeric">Current Versions</th>
                <th class="govuk-table__header govuk-table__header--numeric">Deprecated Versions</th>
            </tr>
        </thead>
        <tbody class="govuk-table__body">
            {% for tenant in tenants %}
                {% if tenant.database.totalDatabases > 0 %}
                <tr class="govuk-table__row">
                    <td class="govuk-table__cell">
                        <strong>{{ tenant.tenantName }}</strong>
                        {% if tenant.tenantDescription %}
                            <br><span class="govuk-body-s" style="color: #505a5f;">{{ tenant.tenantDescription }}</span>
                        {% endif %}
                    </td>
                    <td class="govuk-table__cell govuk-table__cell--numeric">{{ tenant.database.totalDatabases }}</td>
                    <td class="govuk-table__cell govuk-table__cell--numeric" style="background-color: #f0f9f0;">
                        {{ tenant.database.currentVersions }}
                    </td>
                    <td class="govuk-table__cell govuk-table__cell--numeric"{% if tenant.database.deprecatedDatabases > 0 %} style="background-color: #fef2f2;"{% endif %}>
                        {{ tenant.database.deprecatedDatabases }}
                    </td>
                </tr>
                {% endif %}
            {% endfor %}
        </tbody>
    </table>

    {# Load Balancer Compliance Table #}
    <h2 class="govuk-heading-m" id="loadbalancers">
        Load Balancer Compliance
        <a class="govuk-link govuk-body-s" href="#top" style="float: right; font-weight: normal;">Back to top</a>
    </h2>
    <p class="govuk-body-s">
        Shows load balancer distribution and security status. Secure load balancers have HTTPS/TLS listeners configured.
    </p>
    <table class="govuk-table">
        <thead class="govuk-table__head">
            <tr class="govuk-table__row">
                <th class="govuk-table__header" style="width: 25%">Tenant</th>
                <th class="govuk-table__header govuk-table__header--numeric">Total LBs</th>
                <th class="govuk-table__header govuk-table__header--numeric">ALB</th>
                <th class="govuk-table__header govuk-table__header--numeric">NLB</th>
                <th class="govuk-table__header govuk-table__header--numeric">Classic</th>
                <th class="govuk-table__header govuk-table__header--numeric">Secure</th>
                <th class="govuk-table__header govuk-table__header--numeric">Secure Rate</th>
            </tr>
        </thead>
        <tbody class="govuk-table__body">
            {% for tenant in tenants %}
                {% if tenant.loadbalancers.totalLoadBalancers > 0 %}
                <tr class="govuk-table__row">
                    <td class="govuk-table__cell">
                        <strong>{{ tenant.tenantName }}</strong>
                        {% if tenant.tenantDescription %}
                            <br><span class="govuk-body-s" style="color: #505a5f;">{{ tenant.tenantDescription }}</span>
                        {% endif %}
                    </td>
                    <td class="govuk-table__cell govuk-table__cell--numeric">{{ tenant.loadbalancers.totalLoadBalancers }}</td>
                    <td class="govuk-table__cell govuk-table__cell--numeric">{{ tenant.loadbalancers.albCount }}</td>
                    <td class="govuk-table__cell govuk-table__cell--numeric">{{ tenant.loadbalancers.nlbCount }}</td>
                    <td class="govuk-table__cell govuk-table__cell--numeric"{% if tenant.loadbalancers.classicCount > 0 %} style="background-color: #fff3cd;"{% endif %}>
                        {{ tenant.loadbalancers.classicCount }}
                    </td>
                    <td class="govuk-table__cell govuk-table__cell--numeric" style="background-color: #f0f9f0;">
                        {{ tenant.loadbalancers.secureLoadBalancers }}
                    </td>
                    <td class="govuk-table__cell govuk-table__cell--numeric">
                        {% if tenant.loadbalancers.secureRate != 'N/A' %}
                            {{ tenant.loadbalancers.secureRate }}%
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                </tr>
                {% endif %}
            {% endfor %}
        </tbody>
    </table>

    {# KMS Key Compliance Table #}
    <h2 class="govuk-heading-m" id="kms">
        KMS Key Compliance
        <a class="govuk-link govuk-body-s" href="#top" style="float: right; font-weight: normal;">Back to top</a>
    </h2>
    <p class="govuk-body-s">
        Shows KMS key rotation status. Keys with rotation enabled automatically rotate cryptographic material annually.
    </p>
    <table class="govuk-table">
        <thead class="govuk-table__head">
            <tr class="govuk-table__row">
                <th class="govuk-table__header" style="width: 25%">Tenant</th>
                <th class="govuk-table__header govuk-table__header--numeric">Total Keys</th>
                <th class="govuk-table__header govuk-table__header--numeric">With Rotation</th>
                <th class="govuk-table__header govuk-table__header--numeric">Without Rotation</th>
                <th class="govuk-table__header govuk-table__header--numeric">Rotation Rate</th>
            </tr>
        </thead>
        <tbody class="govuk-table__body">
            {% for tenant in tenants %}
                {% if tenant.kms.totalKeys > 0 %}
                <tr class="govuk-table__row">
                    <td class="govuk-table__cell">
                        <strong>{{ tenant.tenantName }}</strong>
                        {% if tenant.tenantDescription %}
                            <br><span class="govuk-body-s" style="color: #505a5f;">{{ tenant.tenantDescription }}</span>
                        {% endif %}
                    </td>
                    <td class="govuk-table__cell govuk-table__cell--numeric">{{ tenant.kms.totalKeys }}</td>
                    <td class="govuk-table__cell govuk-table__cell--numeric" style="background-color: #f0f9f0;">
                        {{ tenant.kms.keysWithRotation }}
                    </td>
                    <td class="govuk-table__cell govuk-table__cell--numeric"{% if (tenant.kms.totalKeys - tenant.kms.keysWithRotation) > 0 %} style="background-color: #fef2f2;"{% endif %}>
                        {{ tenant.kms.totalKeys - tenant.kms.keysWithRotation }}
                    </td>
                    <td class="govuk-table__cell govuk-table__cell--numeric">
                        {% if tenant.kms.rotationRate != 'N/A' %}
                            {{ tenant.kms.rotationRate }}%
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                </tr>
                {% endif %}
            {% endfor %}
        </tbody>
    </table>

    {# Auto Scaling Compliance Table #}
    <h2 class="govuk-heading-m" id="autoscaling">
        Auto Scaling Group Compliance
        <a class="govuk-link govuk-body-s" href="#top" style="float: right; font-weight: normal;">Back to top</a>
    </h2>
    <p class="govuk-body-s">
        Shows Auto Scaling Group status. Empty ASGs have no running instances and may represent cost optimization opportunities.
    </p>
    <table class="govuk-table">
        <thead class="govuk-table__head">
            <tr class="govuk-table__row">
                <th class="govuk-table__header" style="width: 25%">Tenant</th>
                <th class="govuk-table__header govuk-table__header--numeric">Total ASGs</th>
                <th class="govuk-table__header govuk-table__header--numeric">Active ASGs</th>
                <th class="govuk-table__header govuk-table__header--numeric">Empty ASGs</th>
            </tr>
        </thead>
        <tbody class="govuk-table__body">
            {% for tenant in tenants %}
                {% if tenant.autoscaling.totalAsgs > 0 %}
                <tr class="govuk-table__row">
                    <td class="govuk-table__cell">
                        <strong>{{ tenant.tenantName }}</strong>
                        {% if tenant.tenantDescription %}
                            <br><span class="govuk-body-s" style="color: #505a5f;">{{ tenant.tenantDescription }}</span>
                        {% endif %}
                    </td>
                    <td class="govuk-table__cell govuk-table__cell--numeric">{{ tenant.autoscaling.totalAsgs }}</td>
                    <td class="govuk-table__cell govuk-table__cell--numeric" style="background-color: #f0f9f0;">
                        {{ tenant.autoscaling.activeAsgs }}
                    </td>
                    <td class="govuk-table__cell govuk-table__cell--numeric"{% if tenant.autoscaling.emptyAsgs > 0 %} style="background-color: #fff3cd;"{% endif %}>
                        {{ tenant.autoscaling.emptyAsgs }}
                    </td>
                </tr>
                {% endif %}
            {% endfor %}
        </tbody>
    </table>

{% else %}
    <p class="govuk-body">No tenant data available.</p>
{% endif %}
{% endblock %}
